# BLE Sensor Data Reader Test

ESP32 Plant Monitor Rev3ã®BLEã‚»ãƒ³ã‚µãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿å–ã‚‹Pythonãƒ†ã‚¹ãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒˆ

## å¿…è¦ãªç’°å¢ƒ

- Raspberry Pi (3/4/5) ã¾ãŸã¯ Linuxãƒã‚·ãƒ³
- Python 3.7ä»¥ä¸Š
- Bluetoothå¯¾å¿œ

## ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

### 1. å¿…è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

```bash
# ã‚·ã‚¹ãƒ†ãƒ ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®æ›´æ–°
sudo apt-get update
sudo apt-get install -y python3-pip bluetooth bluez

# Pythonãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
pip3 install bleak
```

### 2. Bluetoothæ¨©é™ã®è¨­å®šï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰

```bash
# érootãƒ¦ãƒ¼ã‚¶ãƒ¼ã§Bluetoothä½¿ç”¨ã‚’è¨±å¯
sudo usermod -a -G bluetooth $USER

# å†ãƒ­ã‚°ã‚¤ãƒ³ã¾ãŸã¯ã‚·ã‚¹ãƒ†ãƒ å†èµ·å‹•
```

## ä½¿ç”¨æ–¹æ³•

### åŸºæœ¬çš„ãªä½¿ã„æ–¹

```bash
cd test
python3 ble_read_test.py
```

### ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ ã‚ªãƒ—ã‚·ãƒ§ãƒ³

```bash
# ãƒ˜ãƒ«ãƒ—ã‚’è¡¨ç¤º
python3 ble_read_test.py --help

# ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ã‚’ç„¡åŠ¹åŒ–ï¼ˆå‡ºåŠ›ã‚’ç°¡æ½”ã«ï¼‰
python3 ble_read_test.py --no-debug

# ã‚«ã‚¹ã‚¿ãƒ ãƒ‡ãƒã‚¤ã‚¹åã§æ¤œç´¢
python3 ble_read_test.py --name "My Plant Monitor"

# MACã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ç›´æ¥æŒ‡å®šï¼ˆã‚¹ã‚­ãƒ£ãƒ³ã‚’ã‚¹ã‚­ãƒƒãƒ—ï¼‰
python3 ble_read_test.py --address AA:BB:CC:DD:EE:FF
```

### ãƒ‡ãƒãƒƒã‚°æ©Ÿèƒ½

ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ãŒæœ‰åŠ¹ã«ãªã£ã¦ãŠã‚Šã€ä»¥ä¸‹ã®æƒ…å ±ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ï¼š

- **ã‚¹ã‚­ãƒ£ãƒ³æ™‚**:
  - æ¤œå‡ºã•ã‚ŒãŸã™ã¹ã¦ã®BLEãƒ‡ãƒã‚¤ã‚¹ã®ãƒªã‚¹ãƒˆ
  - å„ãƒ‡ãƒã‚¤ã‚¹ã®åå‰ã€MACã‚¢ãƒ‰ãƒ¬ã‚¹ã€RSSIå€¤

- **æ¥ç¶šæ™‚**:
  - åˆ©ç”¨å¯èƒ½ãªã™ã¹ã¦ã®ã‚µãƒ¼ãƒ“ã‚¹ã¨ç‰¹æ€§
  - å„ç‰¹æ€§ã®UUIDã€ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã€ãƒãƒ³ãƒ‰ãƒ«

- **ãƒ‡ãƒ¼ã‚¿å—ä¿¡æ™‚**:
  - å—ä¿¡ãƒ‡ãƒ¼ã‚¿ã®ãƒã‚¤ãƒŠãƒªãƒ€ãƒ³ãƒ—ï¼ˆ16é€²æ•° + ASCIIï¼‰
  - ãƒ‡ãƒ¼ã‚¿ã‚µã‚¤ã‚ºã¨ç”Ÿãƒ‡ãƒ¼ã‚¿ï¼ˆhexï¼‰

- **ã‚¨ãƒ©ãƒ¼æ™‚**:
  - è©³ç´°ãªã‚¹ã‚¿ãƒƒã‚¯ãƒˆãƒ¬ãƒ¼ã‚¹

### å®Ÿè¡Œä¾‹

```
============================================================
ğŸŒ± Plant Monitor BLE Sensor Data Reader
============================================================

ğŸ” 'Plant Monitor' ãƒ‡ãƒã‚¤ã‚¹ã‚’ã‚¹ã‚­ãƒ£ãƒ³ä¸­...
âœ… ãƒ‡ãƒã‚¤ã‚¹ç™ºè¦‹: Plant Monitor (XX:XX:XX:XX:XX:XX)
ğŸ”Œ ãƒ‡ãƒã‚¤ã‚¹ã«æ¥ç¶šä¸­: XX:XX:XX:XX:XX:XX
âœ… æ¥ç¶šæˆåŠŸ

ğŸ“‹ åˆ©ç”¨å¯èƒ½ãªã‚µãƒ¼ãƒ“ã‚¹:
  ã‚µãƒ¼ãƒ“ã‚¹: 59462f12-9543-9999-12c8-58b459a2712d
    ç‰¹æ€§: 6a3b2c01-4e5f-6a7b-8c9d-e0f123456789 (Properties: ['read'])
    ...

ğŸ“– ã‚»ãƒ³ã‚µãƒ¼ãƒ‡ãƒ¼ã‚¿ç‰¹æ€§ã‚’èª­ã¿å–ã‚Šä¸­...
å—ä¿¡ãƒ‡ãƒ¼ã‚¿ã‚µã‚¤ã‚º: 69 ãƒã‚¤ãƒˆ

============================================================
ğŸ“Š ã‚»ãƒ³ã‚µãƒ¼ãƒ‡ãƒ¼ã‚¿èª­ã¿å–ã‚Šçµæœ
============================================================
ãƒ‡ãƒ¼ã‚¿æ§‹é€ ãƒãƒ¼ã‚¸ãƒ§ãƒ³: 2
ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—: 2025-01-03 15:30:45
æ°—æ¸©: 23.5 Â°C
æ¹¿åº¦: 55.2 %
ç…§åº¦: 1234.5 lux
åœŸå£Œæ°´åˆ†: 2500.0 mV
åœŸå£Œæ¸©åº¦1: 22.3 Â°C
åœŸå£Œæ¸©åº¦2: 0.0 Â°C

ğŸŒ± FDC1004 åœŸå£Œæ¹¿åº¦è¨ˆæ¸¬ç”¨é™é›»å®¹é‡:
  ãƒãƒ£ãƒ³ãƒãƒ« 1: 12.345 pF
  ãƒãƒ£ãƒ³ãƒãƒ« 2: 13.456 pF
  ãƒãƒ£ãƒ³ãƒãƒ« 3: 14.567 pF
  ãƒãƒ£ãƒ³ãƒãƒ« 4: 15.678 pF
============================================================
```

## ãƒ‡ãƒ¼ã‚¿æ§‹é€ 

### ãƒãƒ¼ã‚¸ãƒ§ãƒ³1 (Rev1/Rev2)
- ãƒ‡ãƒ¼ã‚¿æ§‹é€ ãƒãƒ¼ã‚¸ãƒ§ãƒ³: 1ãƒã‚¤ãƒˆ
- ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—: 36ãƒã‚¤ãƒˆ (tm_data_t)
- ç…§åº¦: 4ãƒã‚¤ãƒˆ (float)
- æ°—æ¸©: 4ãƒã‚¤ãƒˆ (float)
- æ¹¿åº¦: 4ãƒã‚¤ãƒˆ (float)
- åœŸå£Œæ°´åˆ†: 4ãƒã‚¤ãƒˆ (float)

**åˆè¨ˆ**: 53ãƒã‚¤ãƒˆ

### ãƒãƒ¼ã‚¸ãƒ§ãƒ³2 (Rev3)
- ãƒ‡ãƒ¼ã‚¿æ§‹é€ ãƒãƒ¼ã‚¸ãƒ§ãƒ³: 1ãƒã‚¤ãƒˆ
- **ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°**: 3ãƒã‚¤ãƒˆ (æ§‹é€ ä½“ã‚¢ãƒ©ã‚¤ãƒ¡ãƒ³ãƒˆ)
- ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—: 36ãƒã‚¤ãƒˆ (tm_data_t)
- ç…§åº¦: 4ãƒã‚¤ãƒˆ (float)
- æ°—æ¸©: 4ãƒã‚¤ãƒˆ (float)
- æ¹¿åº¦: 4ãƒã‚¤ãƒˆ (float)
- åœŸå£Œæ°´åˆ†: 4ãƒã‚¤ãƒˆ (float)
- åœŸå£Œæ¸©åº¦1: 4ãƒã‚¤ãƒˆ (float)
- åœŸå£Œæ¸©åº¦2: 4ãƒã‚¤ãƒˆ (float)
- FDC1004é™é›»å®¹é‡[4]: 16ãƒã‚¤ãƒˆ (4 Ã— float)

**åˆè¨ˆ**: 80ãƒã‚¤ãƒˆ

**æ³¨æ„**: Cè¨€èªã®æ§‹é€ ä½“ã‚¢ãƒ©ã‚¤ãƒ¡ãƒ³ãƒˆã«ã‚ˆã‚Šã€`uint8_t data_version`ã®å¾Œã«3ãƒã‚¤ãƒˆã®ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ãŒè‡ªå‹•æŒ¿å…¥ã•ã‚Œã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Š`tm_data_t`ãŒ4ãƒã‚¤ãƒˆå¢ƒç•Œã«é…ç½®ã•ã‚Œã¾ã™ã€‚

## UUIDå®šç¾©

```python
# ã‚µãƒ¼ãƒ“ã‚¹UUID
SERVICE_UUID = "59462f12-9543-9999-12c8-58b459a2712d"

# ã‚»ãƒ³ã‚µãƒ¼ãƒ‡ãƒ¼ã‚¿ç‰¹æ€§UUID
SENSOR_DATA_CHAR_UUID = "6a3b2c01-4e5f-6a7b-8c9d-e0f123456789"
```

## ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### ãƒ‡ãƒã‚¤ã‚¹ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆ

1. **ESP32ã®é›»æºç¢ºèª**
   ```bash
   # ESP32ã®ã‚·ãƒªã‚¢ãƒ«ãƒ­ã‚°ã‚’ç¢ºèª
   # BLEã‚¢ãƒ‰ãƒã‚¿ã‚¤ã‚¸ãƒ³ã‚°ãŒé–‹å§‹ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
   ```

2. **Bluetoothã‚µãƒ¼ãƒ“ã‚¹ã®ç¢ºèª**
   ```bash
   sudo systemctl status bluetooth
   sudo systemctl restart bluetooth
   ```

3. **æ‰‹å‹•ã‚¹ã‚­ãƒ£ãƒ³**
   ```bash
   sudo hcitool lescan
   # ã¾ãŸã¯
   bluetoothctl
   > scan on
   ```

### æ¥ç¶šã‚¨ãƒ©ãƒ¼ã®å ´åˆ

1. **ESP32ãŒä»–ã®ãƒ‡ãƒã‚¤ã‚¹ã¨æ¥ç¶šã—ã¦ã„ãªã„ã‹ç¢ºèª**
   - ESP32ã¯é€šå¸¸1ã¤ã®BLEæ¥ç¶šã®ã¿ã‚µãƒãƒ¼ãƒˆ
   - ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³ãªã©ãŒæ¥ç¶šã—ã¦ã„ã‚‹å ´åˆã¯åˆ‡æ–­ã™ã‚‹

2. **æ—¢å­˜ã®ãƒšã‚¢ãƒªãƒ³ã‚°æƒ…å ±ã‚’å‰Šé™¤**
   ```bash
   bluetoothctl
   > remove XX:XX:XX:XX:XX:XX
   > exit
   ```

3. **ESP32ã‚’å†èµ·å‹•**
   - é›»æºã‚’å…¥ã‚Œç›´ã—ã¦BLEã‚¹ã‚¿ãƒƒã‚¯ã‚’ãƒªã‚»ãƒƒãƒˆ

4. **Bluetoothã‚¢ãƒ€ãƒ—ã‚¿ã®ãƒªã‚»ãƒƒãƒˆ**
   ```bash
   sudo hciconfig hci0 down
   sudo hciconfig hci0 up
   ```

5. **Raspberry Piã‚’å†èµ·å‹•**
   ```bash
   sudo reboot
   ```

### ãƒ‘ãƒ¼ãƒŸãƒƒã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼ã®å ´åˆ

```bash
# ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’sudoã§å®Ÿè¡Œ
sudo python3 ble_read_test.py

# ã¾ãŸã¯ã€Bluetoothã‚°ãƒ«ãƒ¼ãƒ—ã«è¿½åŠ 
sudo usermod -a -G bluetooth $USER
# å†ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦
```

## å¿œç”¨ä¾‹

### é€£ç¶šèª­ã¿å–ã‚Š

ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ä¿®æ­£ã—ã¦å®šæœŸçš„ã«ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿å–ã‚‹:

```python
# main()é–¢æ•°å†…ã«è¿½åŠ 
while True:
    await read_sensor_data(address)
    await asyncio.sleep(60)  # 60ç§’ã”ã¨ã«èª­ã¿å–ã‚Š
```

### CSVãƒ•ã‚¡ã‚¤ãƒ«ã¸ã®ä¿å­˜

```python
import csv
from datetime import datetime

# ãƒ‡ãƒ¼ã‚¿ã‚’CSVã«ä¿å­˜
with open('sensor_data.csv', 'a', newline='') as csvfile:
    writer = csv.writer(csvfile)
    writer.writerow([
        datetime.now().isoformat(),
        sensor_data['temperature'],
        sensor_data['humidity'],
        sensor_data['lux'],
        sensor_data['soil_moisture'],
        # ...
    ])
```

## ãƒ©ã‚¤ã‚»ãƒ³ã‚¹

ã“ã®ãƒ†ã‚¹ãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¨åŒã˜ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ã®ä¸‹ã§æä¾›ã•ã‚Œã¾ã™ã€‚
